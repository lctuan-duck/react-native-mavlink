# React Native MAVLink - Implementation Summary

## Overview

A complete React Native library for MAVLink communication with drones/UAVs, built using Nitro Modules for high-performance native bridging.

## Architecture

### Layer 1: TypeScript API (React Native)

- **File**: `src/specs/MAVLink.nitro.ts`
- **Purpose**: TypeScript interface definitions for all MAVLink features
- **Key Components**:
  - 8 Type definitions (ConnectionConfig, Coordinate, ManualControlInput, etc.)
  - 40+ method signatures covering all drone operations
  - Enum for ConnectionType (SERIAL, UDP, TCP)

### Layer 2: Nitrogen Code Generator

- **Command**: `npx nitrogen`
- **Input**: MAVLink.nitro.ts
- **Output**: `nitrogen/generated/shared/c++/`
  - HybridMAVLinkSpec.hpp (pure virtual interface)
  - Type struct headers (ConnectionConfig.hpp, Coordinate.hpp, etc.)

### Layer 3: C++ Implementation

#### 3.1 Main Class: HybridMAVLink

- **Files**: `cpp/HybridMAVLink.hpp`, `cpp/HybridMAVLink.cpp`
- **Purpose**: Main implementation inheriting from HybridMAVLinkSpec
- **Responsibilities**:
  - Orchestrates ConnectionManager, VehicleState, CommandExecutor
  - Implements all 40+ API methods
  - Manages message routing
  - Handles timeout checking in background thread
  - Provides Promise-based async API to React Native

#### 3.2 Connection Layer: ConnectionManager

- **Files**: `cpp/connection/ConnectionManager.hpp`, `.cpp`
- **Purpose**: Manages MAVLink connections
- **Features**:
  - UDP connection (fully implemented)
    - Non-blocking sockets
    - Dedicated receive thread (parses MAVLink bytes)
    - Dedicated send thread (queue-based)
  - TCP connection (stubbed)
  - Serial connection (stubbed)
  - Callback system for received messages
  - Connection status callbacks
  - Data stream requests

#### 3.3 Vehicle State: VehicleState

- **Files**: `cpp/vehicle/VehicleState.hpp`, `.cpp`
- **Purpose**: Thread-safe storage of vehicle telemetry
- **Features**:
  - Atomic variables for all telemetry data
  - Message handlers for:
    - HEARTBEAT (system/component ID, armed status, flight mode)
    - GLOBAL_POSITION_INT (GPS position, altitude)
    - ATTITUDE (roll, pitch, yaw)
    - BATTERY_STATUS (voltage, remaining %)
    - GPS_RAW_INT (fix type, satellites)
    - VFR_HUD (speeds, heading)
    - SYS_STATUS (additional status)
  - Flight mode mapping for PX4 and ArduPilot
  - 30+ thread-safe getters

#### 3.4 Command Execution: CommandExecutor

- **Files**: `cpp/commands/CommandExecutor.hpp`, `.cpp`
- **Purpose**: Execute MAVLink commands with reliability
- **Features**:
  - Command queue with pending command tracking
  - Automatic retry logic (3 retries, 3s timeout)
  - ACK handling (MAV*RESULT*\* mappings)
  - Callback-based async completion
  - Timeout checking with retry intervals

### Layer 4: MAVLink Protocol

- **Files**: `cpp/MAVLink/v2.0/` (auto-generated by mavgen)
- **Dialect**: common (standard MAVLink messages)
- **Protocol Version**: MAVLink v2.0
- **Message Types Used**:
  - Telemetry: HEARTBEAT, GLOBAL_POSITION_INT, ATTITUDE, etc.
  - Commands: COMMAND_LONG, COMMAND_ACK
  - Mission: MISSION_COUNT, MISSION_ITEM_INT, MISSION_CURRENT, etc.
  - Parameters: PARAM_REQUEST_LIST, PARAM_VALUE, PARAM_SET
  - Control: SET_POSITION_TARGET_GLOBAL_INT, MANUAL_CONTROL

## Implementation Details

### Thread Safety

- **VehicleState**: All variables use `std::atomic<T>` or protected by `std::mutex`
- **ConnectionManager**: Separate threads for send/receive with queue synchronization
- **CommandExecutor**: Protected command map with mutex for timeout checking

### Async Operations

- All commands return `std::shared_ptr<Promise<T>>`
- Promises resolved/rejected based on command ACK
- React Native receives Promise that resolves when operation completes

### Error Handling

- Connection errors: Return false or throw exceptions caught by Promise
- Command timeouts: Automatic retry up to 3 times, then reject Promise
- Message parsing: Silent drop of malformed messages
- Missing ACK: Timeout after 3 seconds, retry or reject

### Flight Mode Mapping

#### ArduPilot (ArduCopter)

```cpp
0  = STABILIZE
1  = ACRO
2  = ALT_HOLD
3  = AUTO
4  = GUIDED
5  = LOITER
6  = RTL
9  = LAND
16 = POSHOLD
```

#### PX4

```cpp
0  = MANUAL
1  = ALTCTL
2  = POSCTL
3  = AUTO_MISSION
4  = AUTO_LOITER
5  = AUTO_RTL
6  = ACRO
7  = OFFBOARD
8  = STABILIZED
```

### Command Execution Flow

1. **React Native calls**: `await mavlink.guidedTakeoff(10)`
2. **HybridMAVLink**: Calls `executeCommand(MAV_CMD_NAV_TAKEOFF, ...)`
3. **CommandExecutor**:
   - Generates command ID
   - Creates COMMAND_LONG message
   - Stores pending command with callback
   - Sends via ConnectionManager
4. **Autopilot**: Receives command, executes, sends COMMAND_ACK
5. **ConnectionManager**: Receives ACK in receive thread
6. **CommandExecutor**: Handles ACK, calls callback
7. **Promise**: Resolves, returns to React Native

### Telemetry Update Flow

1. **Autopilot**: Broadcasts telemetry messages (HEARTBEAT, GLOBAL_POSITION_INT, etc.)
2. **ConnectionManager**: Receive thread parses bytes with `mavlink_parse_char()`
3. **Message callback**: Routes complete message to handlers
4. **VehicleState**: Updates atomic variables based on message type
5. **React Native**: Calls getters (e.g., `mavlink.getLatitude()`) synchronously
6. **Returns**: Current cached value (no waiting)

## Feature Completeness

### ‚úÖ Fully Implemented

- UDP connection
- Vehicle state management (telemetry)
- Command execution with retry/ACK
- Basic guided commands (takeoff, land, RTL, goto)
- Arm/disarm
- Flight mode changes
- Mission control (start, set current, clear)
- Camera trigger
- Gimbal control
- Manual control input
- Data stream requests

### üîÑ Partially Implemented

- TCP connection (stub exists, needs implementation)
- Serial connection (stub exists, needs platform-specific code)
- Parameter management (set works, get needs request tracking)

### ‚ùå Not Implemented

- Mission upload/download (full waypoint lists)
- FTP file transfer
- Advanced camera control
- Fence/Rally point management
- RC channels override
- Sensor calibration
- Full parameter cache

## Build System

### CMake Configuration

- **File**: `cpp/CMakeLists.txt`
- **Requirements**:
  - CMake 3.9.0+
  - C++17 standard
  - react-native-nitro-modules package
- **Platform-specific linking**:
  - Windows: ws2_32 (Winsock)
  - Linux: pthread
  - macOS: Foundation framework

### Build Output

- Shared library: libReactNativeMAVLink.so/.dylib/.dll
- Linked with Nitro bridge
- Contains all C++ implementations

## Testing Strategy

### Unit Testing (Recommended)

1. **ConnectionManager**: Mock socket operations
2. **VehicleState**: Test message parsing and state updates
3. **CommandExecutor**: Test retry logic and ACK handling

### Integration Testing

1. **SITL (Software In The Loop)**:

   ```bash
   # ArduPilot SITL
   sim_vehicle.py --console --map

   # Connect from React Native
   await connectUDP('127.0.0.1', 14550)
   ```

2. **Real Hardware**:
   - Connect via Serial or UDP (telemetry radio)
   - Test all commands in controlled environment

### Example Test Scenarios

1. Connect ‚Üí Wait for HEARTBEAT ‚Üí Verify systemId
2. Arm ‚Üí Verify armed status change
3. Takeoff ‚Üí Monitor altitude increase
4. Goto ‚Üí Check position updates toward target
5. Land ‚Üí Verify descent and disarm

## Performance Characteristics

### Latency

- **Telemetry getters**: Instant (cached values)
- **Command execution**: 50-200ms (network + autopilot)
- **Connection establishment**: 500-1000ms (HEARTBEAT wait)

### Throughput

- **Receive**: Handles 50+ messages/second (typical MAVLink stream)
- **Send**: Queue-based, no blocking
- **Telemetry update rate**: 4-10Hz (configurable)

### Memory Usage

- **Base overhead**: ~100KB (C++ objects)
- **Per command**: ~200 bytes (pending command tracking)
- **Message queue**: Dynamic, grows with send rate

## Known Limitations

1. **Single Vehicle**: Currently supports one vehicle per instance
2. **No Multi-Threading Safety on JS Side**: React Native calls should be from main thread
3. **Parameter Cache**: No local cache, must query autopilot each time
4. **Mission Upload**: Requires implementing MISSION_REQUEST/MISSION_ACK protocol
5. **Serial Platform-Specific**: Needs separate impl for Windows/Linux/macOS

## Future Enhancements

### Priority 1 (High Impact)

- Complete TCP/Serial connections
- Full parameter management with cache
- Mission upload/download

### Priority 2 (Medium Impact)

- Multi-vehicle support
- Event callbacks (e.g., onArmChanged, onModeChanged)
- Automatic reconnection logic

### Priority 3 (Nice to Have)

- FTP file transfer
- Video streaming integration
- Advanced camera/gimbal control
- Fence/Rally point management

## Dependencies

### Runtime

- React Native 0.70+
- react-native-nitro-modules
- MAVLink v2.0 headers (included)

### Build Time

- CMake 3.9+
- C++17 compiler (clang/gcc/msvc)
- Android NDK (for Android)
- Xcode (for iOS)

### Development

- TypeScript 5.0+
- Nitrogen code generator
- Node.js 18+

## References

### Documentation

- [MAVLink Protocol](https://mavlink.io/en/)
- [QGroundControl Source](https://github.com/mavlink/qgroundcontrol)
- [React Native Nitro](https://github.com/mrousavy/nitro)
- [ArduPilot Docs](https://ardupilot.org/dev/)

### Key Files to Reference

- QGC Vehicle.cc: `/qgroundcontrol/src/Vehicle/Vehicle.cc`
- QGC LinkInterface: `/qgroundcontrol/src/Comms/LinkInterface.h`
- MAVLink Commands: `cpp/MAVLink/v2.0/common/common.h`

## Contact & Support

- **Author**: Le Cong Tuan
- **Email**: lctuan.dev@gmail.com
- **GitHub**: https://github.com/lctuan-duck/react-native-mavlink

---

**Version**: 0.0.1  
**Last Updated**: 2024  
**Status**: Beta - Core features implemented, additional features in progress
